#!/usr/bin/env rundklet
add_note <<~Note
  make metabase handy
  https://hub.docker.com/r/metabase/metabase/
  https://github.com/metabase/metabase
  https://www.metabase.com/docs/latest/operations-guide/running-metabase-on-docker.html
  problems
  https://www.metabase.com/docs/latest/troubleshooting-guide/running.html
  Note with pg: 
  ensure the db has created at first
Note

register_net
register :appname, 'metabase'
register :host_port, 23000

write_dockerfile <<~Desc
  FROM metabase/metabase:v0.30.4
  LABEL <%=image_labels%>
Desc

task :main do
  system_run <<~Desc
    #{dkrun_cmd(named: true)} -d --restart=always \
      -p #{fetch(:host_port)}:3000 \
      -e MB_DB_CONNECTION_URI=postgres://postgres:password@prod_pg_default:5432/metabase \
      -e "JAVA_TIMEZONE=Asia/Shanghai" \
      -e VIRTUAL_HOST=#{domain_for(:metabase, :bi)} \
      #{docker_image}
  Desc
end

custom_commands do
  desc 'open', ''
  option :local, type: :boolean, default: true
  def open
    host = domain_for(:bi)
    host = "#{Dklet::Util.host_ip}:#{fetch(:host_port)}" unless options[:local]
    if options[:dry]
      puts "http://#{host}" 
      return
    end
    system_run <<~Desc
      open http://#{host}
    Desc
  end
end

__END__

-e JAVA_TIMEZONE=US/Pacific
-e "JAVA_TOOL_OPTIONS=-Xmx2g"

---
# compose format
version: '2'
services:
  metabase:
    restart: always
    image: metabase/metabase
    container_name: metabase
    expose:
      - :3000
    environment:
    - MB_DB_TYPE=postgres
    - MB_DB_DBNAME=metabase
    - MB_DB_PORT=5432 
    - MB_DB_USER=postgres
    - MB_DB_PASS=
    - MB_DB_HOST=pgdb
    - JAVA_TIMEZONE=Asia/Shanghai

# docker run way
#{dkrun_cmd(named: true)} -d --restart=always \
  -p 3000 \
  -e "MB_DB_TYPE=postgres" \
  -e "MB_DB_DBNAME=metabase" \
  -e "MB_DB_PORT=5432" \
  -e "MB_DB_USER=postgres" \
  -e "MB_DB_PASS=password" \
  -e "MB_DB_HOST=prod_pg_default" \
  -e "JAVA_TIMEZONE=Asia/Shanghai" \
  #{docker_image}
