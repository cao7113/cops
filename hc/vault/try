#!/usr/bin/env rundklet
add_note <<~Note
  try in server dev mode
Note

register_docker_image "vault:0.11.1"
register :dev_host_port, 18200

task :main do
  # SKIP_SETCAP to skip setcap Memory Locking
  #-e 'VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:1234'
  #-e 'VAULT_DEV_ROOT_TOKEN_ID=myroot' 
  cmd = <<~Desc
    #{dkrun_cmd(named: true)} -d \
      --cap-add=IPC_LOCK \
      -e VAULT_ADDR='http://0.0.0.0:8200' \
      -p #{fetch(:dev_host_port)}:8200 \
      #{docker_image} server -dev -dev-root-token-id=root
  Desc
  # disable_mlock: true
  puts cmd if options[:debug]
  system cmd unless options[:dry]
end

custom_commands do
  desc 'test', 'test vault'
  def test
  end
end
