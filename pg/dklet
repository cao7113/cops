#!/usr/bin/env rundklet

write_dockerfile <<~Desc
  FROM postgres:9.6-alpine
  LABEL maintainer=dailyops
  ADD entrypoint-initdb.d /docker-entrypoint-initdb.d
Desc

registry[:password] = 'password'

task :main do
  # debian /usr/share/postgresql/postgresql.conf.sample
  system <<~Desc
    #docker run -d --name hipg -e POSTGRES_PASSWORD=#{registry[:password]} #{docker_image}
    docker run -d --name hipg -e POSTGRES_PASSWORD=#{registry[:password]} \
      -v "#{script_abspath}/conf/postgresql.conf":/etc/postgresql/postgresql.conf \
      #{docker_image} -c 'config_file=/etc/postgresql/postgresql.conf'
    # -c 'shared_buffers=256MB' -c 'max_connections=200'
  Desc
  
  puts "waiting for initdb..."
  sleep 5
  invoke :psql
end

custom_commands do
  desc 'sampleconf', ''
  def sampleconf
    system <<~Desc
      docker run -i --rm #{docker_image} cat /usr/local/share/postgresql/postgresql.conf.sample | tee #{script_path}/conf/postgresql.conf.sample
    Desc
  end

  desc 'psql', 'open a psql connection'
  def psql
    pgurl = "postgres://postgres:#{registry[:password]}@hipg/postgres"
    # use legacy link --link <name or id>:alias
    system <<~Desc
      docker run -it --rm --link hipg #{docker_image} psql #{pgurl}
    Desc
  end
end

let_cli_magic_start!
