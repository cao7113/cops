#!/usr/bin/env rundklet
add_note <<~Note
  try gemstash as gem cache and mirror
  https://github.com/bundler/gemstash
Note

require_relative 'shared'
register :gemvol, "/Volumes/docker/gemstash"

# https://hub.docker.com/r/govuk/gemstash-alpine/~/dockerfile/
write_dockerfile <<~Desc
  FROM ruby:2.5-alpine3.7
  LABEL maintainer=dailyops
  RUN apk add build-base sqlite-dev && \
      gem install --no-ri --no-rdoc gemstash
  EXPOSE 9292
  VOLUME /root/.gemstash
  ENTRYPOINT ["gemstash"]
  CMD ["start", "--no-daemonize"]
Desc

task :main do
  invoke :netup, [], {}
  system <<~Desc
    docker run -d --name #{fetch(:service)} --net #{netname} \
      -p #{fetch(:host_port)}:#{fetch(:service_port)} \
      -v #{fetch(:gemvol)}:/root/.gemstash \
      -e VIRTUAL_HOST=gemstash.lh \
      #{docker_image}
  Desc
end

custom_commands do
  desc 'ls', 'show volume data'
  def ls
    system <<~Desc
      echo volume at: #{fetch(:gemvol)}
      du -hs #{fetch(:gemvol)}
      ls -l #{fetch(:gemvol)}
    Desc
  end

  # todo list gems index in gemstash or web page
end

