#!/usr/bin/env rundklet

add_note <<~Note
  access services on Mac host from containers
  https://docs.docker.com/docker-for-mac/networking/#known-limitations-use-cases-and-workarounds
Note

write_dockerfile <<~Desc
  FROM nginx:1.15-alpine
  LABEL maintainer=dailyops
Desc

task :main do
  hport = '18181'
  #host_domain = 'docker.for.mac.localhost'
  #host_domain = 'docker.for.mac.host.internal'
  #From 18.03+
  host_domain = 'host.docker.internal'
  # The gateway is also reachable as gateway.docker.internal
  
  system <<~Desc
    docker run --name mock-host-ng -d -p #{hport}:80 #{docker_image}
    docker run --rm -it busybox:1.29 sh -l -c "wget -O- http://#{host_domain}:#{hport}; echo try anything in containers; sh"
  Desc
end

