#!/usr/bin/env ruby
require 'pathname'
require 'erb'

rbfile = ARGV[0]
abort "rbfile required!" if rbfile.nil?

rpath = Pathname(rbfile)
abort "rbfile #{rpath.to_s} existed!" if rpath.exist?

rpath.parent.mkpath
extra = ARGV[1..-1].join(' ')

handler = File.basename(__FILE__)
tmpl = DATA.read
erb = ERB.new(tmpl, nil, '%<>')
result = erb.result(binding)
rpath.write(result)
rpath.chmod(0755)
puts "file: #{rpath} generated by #{handler}!"
exec "#{ENV['EDITOR'] || 'vi'} #{rpath}" if extra =~ /(-o|--open)/

__END__
#!/usr/bin/env rundklet
add_note <<~Note
Note

# https://docs.docker.com/develop/develop-images/dockerfile_best-practices
write_dockerfile <<~Desc
  FROM alpine:3.7
  LABEL <%%=image_labels%>
Desc

task :main do
  system_run <<~Desc
    #{dkrun_cmd(named: true)} -d #{docker_image}
    # #{compose_cmd} up -d
  Desc
end

custom_commands do
  desc 'try', 'try'
  def try
    system_run <<~Desc
      #{dktmprun} echo hi container #{container_name}
    Desc
  end
end
